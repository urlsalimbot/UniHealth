# Registration Controller Debug Guide

## Issues Fixed

### 1. **Role Validation Mismatch** ✅
- **Problem**: Form validated `role` as `'staff,user'` but checked for `'patient'`
- **Fix**: Removed role field requirement, always register as patient role

### 2. **Hardcoded Role** ✅
- **Problem**: Always created user with hardcoded `'patient'` string
- **Fix**: Now uses `User::ROLE_PTNT` constant

### 3. **Missing Patient Validation** ✅
- **Problem**: Patient validation only ran if role matched
- **Fix**: Always validates and looks up patient by UUID

### 4. **Added Debug Logging** ✅
- Logs registration attempts
- Logs patient lookup results
- Logs user creation
- Logs authentication and redirect

## Testing the Registration Flow

### Method 1: Using Test Endpoint (Easiest)

1. **Get test data**:
   ```bash
   curl http://localhost/test-registration-data | jq
   ```
   
   Or visit in browser: `http://localhost/test-registration-data`

2. **Copy the `patient_id` from the response**

3. **Visit registration page**: `http://localhost/register`

4. **Fill in the form**:
   - Name: Test User
   - Email: (use the suggested email from test endpoint)
   - Password: password123
   - Confirm Password: password123
   - Patient ID: (paste the UUID from step 2)

5. **Monitor logs**:
   ```bash
   tail -f storage/logs/laravel.log
   ```

### Method 2: Using QR Code

1. **Get test data**: Visit `http://localhost/test-registration-data`

2. **Download QR code**: Use the `qr_code.url` from the response

3. **Visit registration page**: `http://localhost/register`

4. **Click QR code button** and upload the QR code image

5. **Fill remaining fields** and submit

### Method 3: Using Artisan Command

```bash
php artisan test:registration
```

This will:
- Find a test patient
- Generate QR code
- Check for existing users
- Provide copy-pasteable test data

## What to Look For

### Success Indicators

1. **In Browser**:
   - Form submits without errors
   - Redirects to patient profile page
   - User is logged in

2. **In Logs** (`storage/logs/laravel.log`):
   ```
   [INFO] Registration attempt
   [INFO] Patient found
   [INFO] User created successfully
   [INFO] User logged in, redirecting
   ```

### Common Errors

#### Error: "No matching patient record found"
- **Cause**: Invalid UUID or patient doesn't exist
- **Fix**: Use the test endpoint to get a valid patient_id
- **Check**: Run `php artisan db:seed` if no patients exist

#### Error: "The email has already been taken"
- **Cause**: Email already registered
- **Fix**: Use a different email (test endpoint generates unique ones)

#### Error: "The patient id field is required"
- **Cause**: QR code scanning failed or field is empty
- **Fix**: Manually enter the UUID or try a different QR code image

#### Error: "The patient id field must be a valid UUID"
- **Cause**: QR code contains invalid data
- **Fix**: Ensure QR code was generated by `QrCodeService`

## Database Checks

### Check if patients exist:
```bash
php artisan tinker --execute="echo App\Models\Patients::count() . ' patients';"
```

### Get a patient UUID:
```bash
php artisan tinker --execute="echo App\Models\Patients::first()->patient_id;"
```

### Check if user exists for patient:
```bash
php artisan tinker --execute="
\$patient = App\Models\Patients::first();
\$user = App\Models\User::where('patient_id', \$patient->patient_id)->first();
echo \$user ? 'User exists: ' . \$user->email : 'No user found';
"
```

### Delete test user:
```bash
php artisan tinker --execute="
App\Models\User::where('email', 'testuser@example.com')->delete();
echo 'Deleted';
"
```

## Controller Flow

```
1. User submits registration form
   ↓
2. Validate basic fields (name, email, password, patient_id)
   ↓
3. Look up patient by patient_id UUID
   ↓
4. If patient not found → return error
   ↓
5. If patient found → create user with:
   - name, email, password (hashed)
   - role = 'patient'
   - patient_id = validated UUID
   ↓
6. Fire Registered event
   ↓
7. Log user in
   ↓
8. Redirect to patient profile page
```

## QR Code Format

The QR code contains JSON:
```json
{
  "type": "patient",
  "id": "uuid-here",
  "url": "http://...",
  "generated": "2025-11-03T..."
}
```

The frontend extracts only the `id` field.

## Frontend QR Parsing Logic

```typescript
1. Scan QR code from uploaded image
   ↓
2. Try to parse as JSON
   ↓
3. If JSON with type='patient' and id field:
   → Extract id
   ↓
4. If JSON with id field (no type):
   → Extract id
   ↓
5. If not JSON:
   → Use raw string as UUID
   ↓
6. Populate patient_id field
```

## Quick Test Checklist

- [ ] Database has patients (`php artisan db:seed` if needed)
- [ ] Get test patient UUID from `/test-registration-data`
- [ ] Visit `/register` page
- [ ] Fill form with test data
- [ ] Submit and check for redirect
- [ ] Check logs for success messages
- [ ] Verify user can access patient profile

## Troubleshooting Commands

```bash
# Clear cache
php artisan cache:clear
php artisan config:clear
php artisan route:clear

# Rebuild frontend
npm run build

# Check routes
php artisan route:list | grep register

# View recent logs
tail -n 50 storage/logs/laravel.log

# Test database connection
php artisan tinker --execute="echo 'DB connected: ' . (DB::connection()->getPdo() ? 'Yes' : 'No');"
```
